h1. Clearance

Simple, complete Ruby web app authentication. 

"We have clearance, Clarence.":http://www.youtube.com/v/mNRXJEE3Nz8

h2. Features

* email & password
* modules, not a generator
* gem, not a plugin
* tests included using "shoulda":http://thoughtbot.com/projects/shoulda & "factory_girl":http://thoughtbot.com/projects/factory_girl

h2. Gem installation (Rails 2.1+)

Specify the gem dependency in your config/environment.rb file:

    Rails::Initializer.run do |config|
      # ...
      config.gem 'thoughtbot-shoulda', :lib => 'shoulda', :source => "http://gems.github.com"
      config.gem 'thoughtbot-factory_girl', :lib => 'factory_girl', :source => "http://gems.github.com"
      config.gem "thoughtbot-clearance", :lib => 'clearance', :source => 'http://gems.github.com/'
    end

Then:

    rake gems:install
    rake gems:unpack

h2. Tests

The tests use "Shoulda":http://thoughtbot.com/projects/shoulda and "Factory Girl":http://thoughtbot.com/projects/factory_girl. You should create a User Factory:

    Factory.sequence :email do |n|
      "user#{n}@example.com"
    end

    Factory.define :user do |user|
      user.email { Factory.next :email }
      user.password 'sekrit'
      user.password_confirmation 'sekrit'
    end

In test/test_helper.rb: 

    class Test::Unit::TestCase
      self.use_transactional_fixtures = true
      self.use_instantiated_fixtures  = false
      include Clearance::TestHelper
    end

In test/unit/user_test.rb: 

    class UserTest < Test::Unit::TestCase
      include Clearance::UserTest
    end

In test/functional/sessions_controller_test.rb: 

    class SessionsControllerTest < ActionController::TestCase
      include Clearance::SessionsControllerTest
    end

In test/functional/users_controller_test.rb: 

    class UsersControllerTest < ActionController::TestCase
      include Clearance::UsersControllerTest
    end

h2. Schema

Change your User model so it has these attributes:

    change_table(:users) do |t|
      t.column :email, :string
      t.column :crypted_password, :string, :limit => 40
      t.column :salt, :string, :limit => 40
      t.column :remember_token, :string
      t.column :remember_token_expires_at, :datetime
    end
    
    add_index :users, :email
    add_index :users, :remember_token

h2. User Model

In app/models/user.rb:

    class User < ActiveRecord::Base
      include Clearance::Model
    end

h2. Mailer

In app/models/mailer.rb:

    class Mailer < ActionMailer::Base

		  default_url_options[:host] = HOST

		  def change_password(user)
		    from       "donotreply@example.com"
		    recipients user.email
		    subject    "[YOUR APP] Request to change your password"
		    body       :user => user
		  end

		end

h2. Controllers

In app/controllers/application_controller.rb:

    class ApplicationController < ActionController::Base
      helper :all
      protect_from_forgery
      include Clearance::ApplicationController
    end

In app/controllers/sessions_controller.rb:

    class SessionsController < ApplicationController
      include Clearance::SessionsController

      private
      
      def url_after_create
        root_url # the default
      end
      
      def url_after_destroy
        login_url # the default
      end
    end

In app/controllers/users_controller.rb:

    class UsersController < ApplicationController
      include Clearance::UsersController
    
      private
      
      def url_after_create
        root_url # the default
      end
      
      def url_after_update
        root_url # the default
      end
    end

h2. Routes

    map.with_options :controller => 'sessions'  do |m|
      m.login  '/login',  :action => 'new'
      m.logout '/logout', :action => 'destroy'
    end
    map.resource :session
    map.resources :users

h2. Views

In app/views/sessions/new.html.erb

  <% form_for :session, :url => session_path do |f| %>
	  <div class="group">
	    <%= f.label :email %>
	    <%= f.text_field :email %>  
	  </div>
	  <div class="group">
	    <%= f.label :password %>
	    <%= f.password_field :password %>
	  </div>
	  <div class="checkbox">
	    <%= f.check_box :remember_me %>
	    <%= f.label :remember_me %>
	  </div>
	  <div class="group buttons">
	    <%= f.submit 'Login', :disable_with => 'Please wait...' %>
	  </div>
	<% end %>

h2. Authors

* thoughtbot, inc.
* Dan Croak
* Josh Nichols
* Mike Breen
* Mike Burns
* Jason Morrison
